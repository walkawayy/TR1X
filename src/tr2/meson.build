project(
  'TR2X',
  ['c'],
  default_options: [
    'c_std=c2x',
    'warning_level=3',
  ],
  meson_version: '>=1.3.0',
)

staticdeps = get_option('staticdeps')

trx = subproject('libtrx', default_options: {
  'tr_version': '2',
  'staticdeps': staticdeps,
})
c_compiler = meson.get_compiler('c')

fs = import('fs')
relative_dir = fs.relative_to(meson.current_source_dir(), meson.global_build_root())
build_opts = [
  # common options
  '-Wno-unused',
  '-Wno-unused-parameter',
  '-Wno-microsoft-anon-tag',
  '-Wno-gnu-binary-literal',
  '-Wno-gnu-empty-initializer',
  '-Wno-gnu-zero-variadic-macro-arguments',
  '-DMESON_BUILD',
  '-fms-extensions',
  '-fno-omit-frame-pointer',
  # end of common options
  '-ffile-prefix-map=@0@/='.format(relative_dir),
  '-DTR_VERSION=2',
] + trx.get_variable('defines')

add_project_arguments(build_opts, language: 'c')

# Always dynamically link on macOS
if host_machine.system() == 'darwin'
  staticdeps = false
endif

null_dep = dependency('', required: false)
dep_trx = trx.get_variable('dep_trx')
dep_sdl2 = dependency('SDL2', static: staticdeps)
dep_mathlibrary = c_compiler.find_library('m', static: staticdeps, required : false)

# autogenerated files
resources = []
python3 = find_program('python3', required: true)
git = find_program('git', required: true)

init = custom_target(
  'fake_init',
  output: ['init.c'],
  command: [python3, meson.project_source_root() + '/../../tools/tr2/generate_init', '-o', meson.current_build_dir() / '@OUTPUT0@'],
  build_always_stale: true,
)

version_rc = custom_target(
  'fake_version',
  output: ['version.rc'],
  command: [python3, meson.project_source_root() + '/../../tools/tr2/generate_rcfile', '-o', '@OUTPUT0@'],
  build_always_stale: true,
)

icon_rc = custom_target(
  'fake_icon',
  output: ['icon.rc'],
  command: [python3, meson.project_source_root() + '/../../tools/tr2/generate_rcfile', '-o', '@OUTPUT0@'],
)

link_args = []

if host_machine.system() == 'windows'
  windows = import('windows')

  version_resource = windows.compile_resources(version_rc)
  icon_resource = windows.compile_resources(icon_rc)
  resources = [version_resource, icon_resource]

  link_args += ['-static']
endif

sources = [
  init,
  'decomp/decomp.c',
  'decomp/flares.c',
  'decomp/savegame.c',
  'decomp/skidoo.c',
  'decomp/stats.c',
  'game/box.c',
  'game/camera.c',
  'game/clock.c',
  'game/collide.c',
  'game/console/common.c',
  'game/console/setup.c',
  'game/creature.c',
  'game/cutscene.c',
  'game/demo.c',
  'game/effects.c',
  'game/fmv.c',
  'game/game.c',
  'game/game_string.c',
  'game/game_flow/common.c',
  'game/game_flow/reader.c',
  'game/game_flow/inventory.c',
  'game/game_flow/sequencer.c',
  'game/game_flow/vars.c',
  'game/gun/gun.c',
  'game/gun/gun_misc.c',
  'game/gun/gun_pistols.c',
  'game/gun/gun_rifle.c',
  'game/inject.c',
  'game/input.c',
  'game/inventory.c',
  'game/inventory_ring/control.c',
  'game/inventory_ring/draw.c',
  'game/inventory_ring/vars.c',
  'game/item_actions.c',
  'game/items.c',
  'game/lara/cheat.c',
  'game/lara/cheat_keys.c',
  'game/lara/col.c',
  'game/lara/common.c',
  'game/lara/control.c',
  'game/lara/draw.c',
  'game/lara/hair.c',
  'game/lara/look.c',
  'game/lara/misc.c',
  'game/lara/state.c',
  'game/level.c',
  'game/los.c',
  'game/lot.c',
  'game/music/music_backend_cdaudio.c',
  'game/music/music_backend_files.c',
  'game/music/music_main.c',
  'game/objects/common.c',
  'game/objects/creatures/bandit_1.c',
  'game/objects/creatures/bandit_2.c',
  'game/objects/creatures/barracuda.c',
  'game/objects/creatures/bartoli.c',
  'game/objects/creatures/big_eel.c',
  'game/objects/creatures/big_spider.c',
  'game/objects/creatures/bird.c',
  'game/objects/creatures/bird_guardian.c',
  'game/objects/creatures/cultist_1.c',
  'game/objects/creatures/cultist_2.c',
  'game/objects/creatures/cultist_3.c',
  'game/objects/creatures/diver.c',
  'game/objects/creatures/dog.c',
  'game/objects/creatures/dragon.c',
  'game/objects/creatures/eel.c',
  'game/objects/creatures/jelly.c',
  'game/objects/creatures/monk.c',
  'game/objects/creatures/mouse.c',
  'game/objects/creatures/shark.c',
  'game/objects/creatures/skidoo_driver.c',
  'game/objects/creatures/spider.c',
  'game/objects/creatures/tiger.c',
  'game/objects/creatures/trex.c',
  'game/objects/creatures/winston.c',
  'game/objects/creatures/worker_1.c',
  'game/objects/creatures/worker_2.c',
  'game/objects/creatures/worker_3.c',
  'game/objects/creatures/xian_common.c',
  'game/objects/creatures/xian_knight.c',
  'game/objects/creatures/xian_spearman.c',
  'game/objects/creatures/yeti.c',
  'game/objects/effects/blood.c',
  'game/objects/effects/body_part.c',
  'game/objects/effects/bubble.c',
  'game/objects/effects/dart_effect.c',
  'game/objects/effects/ember.c',
  'game/objects/effects/explosion.c',
  'game/objects/effects/flame.c',
  'game/objects/effects/glow.c',
  'game/objects/effects/gun_flash.c',
  'game/objects/effects/hot_liquid.c',
  'game/objects/effects/missile_common.c',
  'game/objects/effects/missile_flame.c',
  'game/objects/effects/missile_harpoon.c',
  'game/objects/effects/missile_knife.c',
  'game/objects/effects/ricochet.c',
  'game/objects/effects/snow_sprite.c',
  'game/objects/effects/splash.c',
  'game/objects/effects/twinkle.c',
  'game/objects/effects/water_sprite.c',
  'game/objects/general/alarm_sound.c',
  'game/objects/general/bell.c',
  'game/objects/general/big_bowl.c',
  'game/objects/general/bird_tweeter.c',
  'game/objects/general/bridge_common.c',
  'game/objects/general/bridge_flat.c',
  'game/objects/general/bridge_tilt_1.c',
  'game/objects/general/bridge_tilt_2.c',
  'game/objects/general/camera_target.c',
  'game/objects/general/clock_chimes.c',
  'game/objects/general/copter.c',
  'game/objects/general/cutscene_player.c',
  'game/objects/general/detonator.c',
  'game/objects/general/ding_dong.c',
  'game/objects/general/door.c',
  'game/objects/general/drawbridge.c',
  'game/objects/general/earthquake.c',
  'game/objects/general/final_cutscene.c',
  'game/objects/general/final_level_counter.c',
  'game/objects/general/flare_item.c',
  'game/objects/general/general.c',
  'game/objects/general/gong_bonger.c',
  'game/objects/general/grenade.c',
  'game/objects/general/harpoon_bolt.c',
  'game/objects/general/keyhole.c',
  'game/objects/general/lara_alarm.c',
  'game/objects/general/lift.c',
  'game/objects/general/mini_copter.c',
  'game/objects/general/movable_block.c',
  'game/objects/general/pickup.c',
  'game/objects/general/puzzle_hole.c',
  'game/objects/general/secret.c',
  'game/objects/general/sphere_of_doom.c',
  'game/objects/general/switch.c',
  'game/objects/general/trapdoor.c',
  'game/objects/general/waterfall.c',
  'game/objects/general/window.c',
  'game/objects/general/zipline.c',
  'game/objects/setup.c',
  'game/objects/traps/blade.c',
  'game/objects/traps/dart.c',
  'game/objects/traps/dart_emitter.c',
  'game/objects/traps/dying_monk.c',
  'game/objects/traps/ember_emitter.c',
  'game/objects/traps/falling_block.c',
  'game/objects/traps/falling_ceiling.c',
  'game/objects/traps/flame_emitter.c',
  'game/objects/traps/gondola.c',
  'game/objects/traps/hook.c',
  'game/objects/traps/icicle.c',
  'game/objects/traps/killer_statue.c',
  'game/objects/traps/mine.c',
  'game/objects/traps/pendulum.c',
  'game/objects/traps/power_saw.c',
  'game/objects/traps/propeller.c',
  'game/objects/traps/rolling_ball.c',
  'game/objects/traps/spike_ceiling.c',
  'game/objects/traps/spike_wall.c',
  'game/objects/traps/spikes.c',
  'game/objects/traps/spinning_blade.c',
  'game/objects/traps/springboard.c',
  'game/objects/traps/teeth_trap.c',
  'game/objects/vars.c',
  'game/objects/vehicles/boat.c',
  'game/objects/vehicles/skidoo_armed.c',
  'game/objects/vehicles/skidoo_fast.c',
  'game/option/option.c',
  'game/option/option_compass.c',
  'game/option/option_controls.c',
  'game/option/option_detail.c',
  'game/option/option_passport.c',
  'game/option/option_sound.c',
  'game/output.c',
  'game/overlay.c',
  'game/render/common.c',
  'game/render/hwr.c',
  'game/render/priv.c',
  'game/render/swr.c',
  'game/render/util.c',
  'game/requester.c',
  'game/room.c',
  'game/room_draw.c',
  'game/savegame/common.c',
  'game/scaler.c',
  'game/shell/common.c',
  'game/shell/input.c',
  'game/sound.c',
  'game/spawn.c',
  'game/stats.c',
  'game/text.c',
  'game/ui/common.c',
  'game/ui/controllers/controls.c',
  'game/ui/widgets/controls_backend_selector.c',
  'game/ui/widgets/controls_column.c',
  'game/ui/widgets/controls_dialog.c',
  'game/ui/widgets/controls_input_selector.c',
  'game/ui/widgets/controls_layout_editor.c',
  'game/ui/widgets/controls_layout_selector.c',
  'game/ui/widgets/stats_dialog.c',
  'game/viewport.c',
  'global/enum_map.c',
  'global/vars.c',
  'main.c',
  resources,
]

dependencies = [
  dep_trx,
  dep_sdl2,
  dep_mathlibrary,
]

executable(
  'TR2X',
  sources,
  name_prefix: '',
  link_args: link_args,
  dependencies: dependencies,
  win_subsystem: 'windows',
  install: true,
)

if host_machine.system() == 'darwin'
  install_subdir('../../data/tr2/ship/cfg', install_dir : 'Contents/Resources')
  install_subdir('../../data/tr2/ship/data', install_dir : 'Contents/Resources')
  install_subdir('../../data/tr2/ship/shaders', install_dir : 'Contents/Resources')
  install_data('../../data/tr2/mac/icon.icns', install_dir : 'Contents/Resources')
  install_data('../../data/tr2/mac/Info.plist', install_dir : 'Contents')
  meson.add_install_script('../../tools/shared/mac/bundle_dylibs', '-a', 'TR2X')
endif
